# 新功能说明文档

## 更新日期：2025年12月1日

### 1. 预约时长限制 ⏱️

**功能描述**：每个用户每周最多预约6小时

**实现细节**：
- 在创建预约时自动计算本周已预约时长
- 本周定义：周一到周日
- 如果新预约会导致超过6小时限制，系统会拒绝预约
- 错误提示会显示已使用时长

**使用示例**：
```
用户A本周已预约：
- 周一 14:00-17:00 (3小时)
- 周三 10:00-12:00 (2小时)
总计：5小时

尝试预约周五 15:00-17:00 (2小时)
结果：失败 ❌
原因：5 + 2 = 7小时 > 6小时限制
```

### 2. 新用户注册审核机制 🔐

**功能描述**：所有新注册用户默认为禁用状态，需要管理员手动启用

**实现细节**：

#### 注册流程变更
- 新用户注册成功后账号状态为"禁用"
- 不再自动生成访问令牌
- 返回提示：`"Your account needs to be activated by an administrator."`
- 禁用状态的用户无法登录

#### 登录验证
- 登录时检查账号是否启用
- 禁用账号登录返回403错误：`"Account is disabled"`

#### 预约验证
- 创建预约时检查用户状态
- 禁用用户无法创建预约

**管理员操作**：
1. 进入"用户管理"页面
2. 查看禁用状态的新用户
3. 点击"启用"按钮激活账号
4. 用户即可正常登录和使用

### 3. 年度用户重置 🗓️

**功能描述**：每年1月1日自动重置所有普通用户为禁用状态

**实现方式**：

#### 自动定时任务
- 使用APScheduler定时调度器
- 执行时间：每年1月1日 00:00
- 只禁用非管理员用户
- 管理员账号不受影响

#### 手动执行
管理员可在"用户管理"页面手动触发年度重置：
1. 点击"年度重置"按钮
2. 确认操作（会显示警告）
3. 系统禁用所有普通用户
4. 显示禁用用户数量

**注意事项**：
- ⚠️ 年度重置会禁用所有普通用户（管理员除外）
- 用户需要管理员重新启用才能使用系统
- 建议在学年开始前执行

### 4. 用户管理筛选功能 🔍

**功能描述**：管理员可以通过多个维度筛选和搜索用户

#### 筛选选项

**1. 按状态筛选**
- 选项：启用 / 禁用
- 用途：快速查找待审核的新用户或已禁用用户

**2. 按入学年份筛选**
- 选项：最近10年（2015-2024）
- 原理：根据学号前两位匹配年份
- 示例：选择"2024级"会筛选学号包含"24"的用户

**3. 按姓名搜索**
- 实时搜索（500ms防抖）
- 支持模糊匹配
- 输入即时更新结果

#### 组合筛选
可以同时使用多个筛选条件：
```
状态：禁用
年份：2024级
搜索：张三
结果：2024级入学、名字包含"张三"的禁用用户
```

#### 清空筛选
- 每个筛选器都支持清空
- 清空后恢复显示所有用户

### 5. 批量用户操作 📦

**批量激活功能**（API已实现）：
```javascript
// 批量激活多个用户
POST /api/admin/users/batch-activate
Body: {
  "user_ids": [1, 2, 3, 4, 5]
}
```

### API端点更新

#### 新增端点

```
POST /api/admin/users/annual-reset
- 执行年度用户重置
- 需要管理员权限
- 返回禁用用户数量

POST /api/admin/users/batch-activate
- 批量激活用户
- 需要管理员权限
- 参数：user_ids (数组)

GET /api/admin/users?is_active={true|false}&year={2024}&search={关键词}
- 获取用户列表（支持筛选）
- 参数：
  - is_active: 筛选启用/禁用状态
  - year: 筛选入学年份
  - search: 搜索姓名
```

### 数据库更新

无需修改数据库结构，所有功能基于现有字段实现：
- `is_active`: 用户启用状态
- `student_id`: 学号（用于年份筛选）
- `created_at`: 注册时间

### 依赖更新

新增依赖（已添加到 requirements.txt）：
```
APScheduler==3.10.4
```

安装命令：
```bash
cd backend
source venv/bin/activate
pip install APScheduler
```

### 前端组件更新

**Admin.vue 更新**：
- 添加用户筛选器（状态、年份、搜索）
- 添加"年度重置"按钮
- 搜索防抖优化（500ms）
- 筛选条件联动查询

**样式优化**：
- `.filter-section`: 筛选区域布局
- 移动端自适应

### 使用场景

#### 场景1：新学年开始
1. 管理员执行"年度重置"
2. 所有老用户账号被禁用
3. 新生注册账号（自动禁用）
4. 管理员审核并批量激活新生账号
5. 根据需要重新激活部分老生账号

#### 场景2：日常用户审核
1. 新用户注册
2. 管理员筛选"禁用状态"用户
3. 审核新注册信息
4. 逐个或批量启用账号

#### 场景3：问题用户管理
1. 筛选特定年级（如2024级）
2. 查看该年级用户列表
3. 根据需要禁用/启用特定用户

### 测试建议

1. **预约限制测试**：
   - 创建6小时预约
   - 尝试再预约1小时
   - 验证拒绝提示

2. **注册审核测试**：
   - 注册新用户
   - 验证无法登录
   - 管理员启用
   - 验证可以登录

3. **筛选功能测试**：
   - 测试单一筛选
   - 测试组合筛选
   - 测试搜索功能

4. **年度重置测试**：
   - 手动触发重置
   - 验证普通用户被禁用
   - 验证管理员未受影响

### 注意事项

⚠️ **重要提醒**：

1. **首次使用**需要安装APScheduler依赖
2. **年度重置**是破坏性操作，谨慎使用
3. **管理员账号**不能被禁用
4. **学号格式**需符合规范才能正确筛选年份
5. **定时任务**在app.py启动时自动初始化

### 故障排除

**问题1**：定时任务未启动
```
解决：检查APScheduler是否正确安装
pip list | grep APScheduler
```

**问题2**：年份筛选不准确
```
解决：确保学号格式包含年份信息（如BY24XXXXXXXX）
```

**问题3**：新用户无法登录
```
解决：这是正常现象，管理员需手动启用新用户
```
