# 不可预约时间功能更新说明

## 更新概述

将不可预约时间从"绝对日期"改为支持三种灵活的时间规则：

1. **固定周几** - 例如：每周一 8:00-12:00 维护时间
2. **所有日期** - 例如：每天 0:00-7:00 休息时间
3. **特定日期** - 例如：2025-12-25 全天关闭（保留原功能）

## 数据库变更

### UnavailableTime 表
- 新增字段：`day_of_week` (INTEGER, nullable) - 0=周日, 1=周一, ..., 6=周六
- 修改字段：`date` (DATE) - 改为可空
- 扩展字段：`start_hour`, `end_hour` - 范围从 8-22 扩展为 0-24

### 迁移步骤

```bash
cd backend
python migrate_unavailable_times.py
```

## 前端变更

### Admin.vue
- 添加时间规则类型选择器（单选按钮组）
- 根据规则类型动态显示对应的输入框：
  - 固定周几：显示周几下拉选择
  - 所有日期：不显示额外输入
  - 特定日期：显示日期选择器（原功能）
- 表格显示优化：根据规则类型显示对应的时间信息

### 表单示例

**固定周几：**
- 校区：学院路校区
- 时间规则：固定周几
- 周几：周一
- 时间：8:00-12:00
- 原因：每周一维护时间

**所有日期：**
- 校区：沙河校区
- 时间规则：所有日期
- 时间：0:00-7:00
- 原因：每日休息时间

**特定日期：**
- 校区：学院路校区
- 时间规则：特定日期
- 日期：2025-12-25
- 时间：0:00-24:00
- 原因：圣诞节闭馆

## 后端变更

### routes/admin.py
- 更新 `create_unavailable_time` 接口
  - 移除 `date` 必填限制
  - 添加 `day_of_week` 可选参数
  - 扩展时间范围验证（0-24）

### routes/reservation.py
- 更新 `check_unavailable_time` 函数
  - 检查特定日期的不可预约时间
  - 检查固定周几的不可预约时间
  - 检查所有日期的不可预约时间

### models.py
- 更新 `UnavailableTime` 模型
  - 添加 `day_of_week` 字段
  - `date` 改为可空
  - 更新 `to_dict()` 方法

## API 接口变更

### POST /api/admin/unavailable-times

**请求体（固定周几）：**
```json
{
  "campus_id": 1,
  "day_of_week": 1,
  "start_hour": 8,
  "end_hour": 12,
  "reason": "每周一维护时间"
}
```

**请求体（所有日期）：**
```json
{
  "campus_id": 1,
  "start_hour": 0,
  "end_hour": 7,
  "reason": "每日休息时间"
}
```

**请求体（特定日期）：**
```json
{
  "campus_id": 1,
  "date": "2025-12-25",
  "start_hour": 0,
  "end_hour": 24,
  "reason": "圣诞节闭馆"
}
```

**响应：**
```json
{
  "id": 1,
  "campus_id": 1,
  "campus_name": "学院路校区",
  "date": null,
  "day_of_week": 1,
  "start_hour": 8,
  "end_hour": 12,
  "reason": "每周一维护时间",
  "created_at": "2025-12-01T12:00:00"
}
```

## 使用场景

### 1. 固定维护时间
每周一 8:00-12:00 进行设备维护
```
规则类型：固定周几
周几：周一
时间：8:00-12:00
```

### 2. 每日休息时间
每天凌晨到早上不可预约
```
规则类型：所有日期
时间：0:00-7:00
```

### 3. 节假日闭馆
特定日期全天关闭
```
规则类型：特定日期
日期：2025-12-25
时间：0:00-24:00
```

### 4. 周末特殊时段
每周六日上午不开放
```
规则类型：固定周几
周几：周六（或周日，需分别添加）
时间：0:00-12:00
```

## 兼容性说明

- ✅ 现有的特定日期规则完全兼容
- ✅ 前端自动识别并正确显示三种类型
- ✅ 后端预约检查自动支持所有规则类型
- ✅ 数据库迁移保留所有现有数据

## 测试建议

1. 创建固定周几规则，验证预约时是否正确拦截
2. 创建所有日期规则，验证任意日期都会拦截
3. 创建特定日期规则，验证只在该日期拦截
4. 验证多条规则可以同时生效
5. 验证删除规则后预约恢复正常
